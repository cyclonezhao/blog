---
layout: post
title:  索引基础
date:   2019-04-12 12:37:00:00 +0800
tags:
  - 数据库理论
categories:
  - 软件开发
mathjax: true
---

索引是一种存取结构

# 主索引、聚簇索引和辅助索引

根据字段类型是否码字段，可以有如下**第一种索引分类方式**：

* **主索引**，如果记录文件使用一码字段进行物理排序，基于此字段建立的索引称作主索引
* **聚簇索引**，如果记录文件使用一个非码字段进行物理排序，该字段称作聚簇字段，基于聚簇字段建立的索引称作聚簇索引
* **辅助索引**，是基于记录的非排序字段建立的索引

<!-- more -->

由于一个文件最多只能有一个物理排序字段，因此一个文件最多只能有一个主索引或一个聚簇索引；而辅助索引则可有多个。

索引由索引项组成，索引项可表示为`<k(i), p(i)>`。

在主索引中，k(i)是块锚的索引字段值，p(i)是指向块锚的指针。一条索引项的长度小于一条记录的长度，因此一个磁盘块可存储更多的索引项。

> **磁盘块**是磁盘和主存的数据传输单位。一个磁盘块可有多条记录，**块因子** bfr (Blocking Factor) 表示一个磁盘块所拥有的记录数。如果取B为一个磁盘块的容量，R为一条记录所占用的容量，则 $ bfr = \lfloor B/R \rfloor $ 。一个磁盘块的第一条记录称为该块的锚记录，或简称块锚。

由于聚簇字段在记录文件中的取值不唯一，同一个聚簇字段值对应的记录可能需要存放在一个或多个块中。常见的做法是为每一个值预留一个整块（或一个连续的块簇），k(i)取聚簇字段值，p(i)取指向对应块的首条记录的指针。

# 稠密索引和稀疏索引

根据索引项数目和记录数目的比例，可有如下**第二种索引分类方式**：

* **稠密索引**，每条记录都存在对应的一条索引项
* **稀疏索引**，只有部分记录有对应的索引项

关于主索引，由于在记录文件中只有块锚才存在对应的索引项，所以是稀疏索引。

聚簇索引由于每个聚簇字段值对应一个索引项，而同一个聚簇字段值可能会对应多条记录，所以也是稀疏索引。

辅助索引由于使用无序字段作为索引字段，没法使用记录文件的块锚。如果采用候选码作为索引字段，那必须为每个记录建立一个索引项，此时它是稠密索引。而如果采用非码字段作为索引字段，则索引字段取值不唯一，此时根据实现方式的不同，辅助索引可为稠密索引或稀疏索引。

# 索引如何提升查询效率

如果采用对磁盘快访问次数多少作为衡量查询效率的指标，那么考虑以下例子：

例子1：如果一个磁盘块大小B=1024字节，一个文件包含的记录数r=30000个，每条记录的长度R=100字节，记录定长且不跨块。那么存储该文件所需块数b等于多少，二分查找该文件需进行多少次块访问？

解：
块因子 $ bfr=\lfloor B/R \rfloor = 10 $ 个记录/块
存储文件所需块数 $ b=\lceil r/bfr \rceil=3000 $ 块
块访问次数=$ \lceil \log _{2} b \rceil = 12 $ 次

例子2：在例子1的基础上，如果有建立主索引，其中码字段长9字节（记做K），块指针长6字节（记做P），那么二分查找该索引文件需进行多少次块访问？

解：
一条索引项长度 $ R_i=K+P=15 $ 字节
索引块因子（一个磁盘块可以存储的索引项个数）$ bfr_i = \lfloor B/R_i \rfloor = 68$
索引项的总数=记录文件的块数=3000个，因此索引文件所需块数$ b_i = \lceil b/bfr_i \rceil = 45$ 块，块访问次数=$ \lceil \log _{2} b_i \rceil + 1 = 6+1 = 7 $ 次，多出的一次是对记录块的访问。

例子3：如果使用无须字段作为查询字段，直接线性查找记录文件平均需要多少次块访问？如果存在辅助索引，则需要多少次块访问？

解：
直接线性查找记录文件平均需要 $ b/2=1500 $ 次块访问
辅助索引的索引项数量 $ r_i = r = 30000 $ 个
索引文件所需块数 $ b_i = \lceil r_i/bfr_i \rceil = \lceil 30000/68 \rceil = 442 $ 块
块访问次数=$ \lceil \log _{2} b_i \rceil + 1 = 9+1 = 10 $ 次

相比主索引的7次块访问，辅助索引稍差一点，但是比起直接线性查找记录文件所需的平均1500次块访问，辅助索引更显著地减少了对磁盘块的访问次数。